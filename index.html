<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>è»½é‡å‹•ç”»ãƒªã‚¹ãƒˆ</title>
  <style>
    body { font-family: sans-serif; }
    .video-item { cursor: pointer; margin-bottom: 20px; }
    .video-item img { max-width: 100%; display: block; }
    iframe { width: 100%; max-width: 560px; height: 315px; }
  </style>
</head>
<body>
  <h1>å‹•ç”»ä¸€è¦§ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å†ç”Ÿï¼‰</h1>
  <div id="videos">èª­ã¿è¾¼ã¿ä¸­...</div>

  <script>
    const apiKey = "AIzaSyAxk1YpQSe-qDtFUSUmnjnduanag41Mlyk";
    const playlistId = "PLsHj_P-wUyYnbIgioZx3iat9EzihpACzw";
    const container = document.getElementById("videos");

    // ISO8601 duration â†’ ç§’ã¸å¤‰æ›
    function parseDuration(duration) {
      const match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
      const hours = parseInt(match?.[1]) || 0;
      const minutes = parseInt(match?.[2]) || 0;
      const seconds = parseInt(match?.[3]) || 0;
      return hours * 3600 + minutes * 60 + seconds;
    }

    // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆå…¨å–å¾—
    async function fetchAllVideos() {
      let allItems = [];
      let pageToken = "";

      while (true) {
        const url = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=${playlistId}&key=${apiKey}&pageToken=${pageToken}`;
        const res = await fetch(url);
        const data = await res.json();

        if (data.error) throw new Error(JSON.stringify(data.error));

        allItems = allItems.concat(data.items);

        if (!data.nextPageToken) break;
        pageToken = data.nextPageToken;
      }

      return allItems;
    }

    // 50ä»¶ãšã¤åˆ†å‰²ã—ã¦durationå–å¾—
    async function getDurations(videoIds) {
      const durationMap = {};

      for (let i = 0; i < videoIds.length; i += 50) {
        const chunk = videoIds.slice(i, i + 50);
        const url = `https://www.googleapis.com/youtube/v3/videos?part=contentDetails&id=${chunk.join(",")}&key=${apiKey}`;
        const res = await fetch(url);
        const data = await res.json();

        if (data.error) throw new Error(JSON.stringify(data.error));

        data.items.forEach(v => {
          durationMap[v.id] = parseDuration(v.contentDetails.duration);
        });
      }

      return durationMap;
    }

    async function init() {
      try {
        const items = await fetchAllVideos();

        if (!items.length) {
          container.innerText = "å‹•ç”»ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
          return;
        }

        const videoIds = items.map(item => item.snippet.resourceId.videoId);
        const durationMap = await getDurations(videoIds);

        container.innerHTML = "";

        items.forEach(item => {
          const title = item.snippet.title;
          const videoId = item.snippet.resourceId.videoId;
          const thumbnail = item.snippet.thumbnails.medium.url;

          // ğŸ”¥ 60ç§’ä»¥ä¸‹ã¯é™¤å¤–ï¼ˆShortsåˆ¤å®šï¼‰
          if (!durationMap[videoId] || durationMap[videoId] <= 60) return;

          const div = document.createElement("div");
          div.className = "video-item";

          div.innerHTML = `
            <img src="${thumbnail}" alt="${title}" />
            <p>${title}</p>
          `;

          div.onclick = () => {
            div.innerHTML = `
              <iframe
                src="https://www.youtube.com/embed/${videoId}?rel=0"
                frameborder="0"
                allowfullscreen
                loading="lazy">
              </iframe>
            `;
          };

          container.appendChild(div);
        });

        if (!container.innerHTML.trim()) {
          container.innerText = "é€šå¸¸å‹•ç”»ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆShortsã®ã¿ã®å¯èƒ½æ€§ï¼‰ã€‚";
        }

      } catch (err) {
        console.error(err);
        container.innerText = "APIã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚Consoleã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
      }
    }

    init();
  </script>
</body>
</html>
